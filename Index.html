<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bot Assistant</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 10px;
      font-size: 14px;
    }

    .section {
      margin-bottom: 20px;
    }

    .label {
      font-weight: bold;
    }

    .value {
      margin: 5px 0;
      color: #333;
    }

    .loader {
      font-style: italic;
      color: gray;
    }
  </style>
</head>
<body>
  <div class="section">
    <div class="label">Visitor Question:</div>
    <div id="visitor-question" class="value loader">Loading...</div>
  </div>
  <div class="section">
    <div class="label">Bot Response:</div>
    <div id="bot-response" class="value loader">Waiting for response...</div>
  </div>

  <script src="https://cdn.livechatinc.com/agent-app-sdk/1.4.9/agent-app-sdk.min.js"></script>
  <script>
    const visitorQuestionDiv = document.getElementById("visitor-question");
    const botResponseDiv = document.getElementById("bot-response");

    async function getBotReply(question) {
      try {
        const response = await fetch("https://api.botatwork.com/trigger-task/42eaa2c8-e8aa-43ad-b9b5-944981bce2a2", {
          method: "POST",
          headers: {
           "Content-Type": "application/json",
            "x-api-key": "bf2e2d7e409bc0d7545e14ae15a773a3"
          },
          body: JSON.stringify({ question })
        });

        const result = await response.json();
        return data?.data?.content || data?.message || "Bot did not return a valid response.";
      } catch (err) {
        console.error("Bot fetch error:", err);
        return "Error contacting bot API.";
      }
    }

    LiveChatWidget.init();

    LiveChatWidget.on("ready", async () => {
      try {
        const chatContext = await LiveChatWidget.get("chat");
        const chatId = chatContext.chatId;

        const thread = await LiveChatWidget.get("chatThread", { chatId });
        const events = thread.events;

        const lastVisitorMessage = [...events].reverse().find(e => e.author_type === "visitor" && e.type === "message");

        if (lastVisitorMessage && lastVisitorMessage.text) {
          const question = lastVisitorMessage.text;
          visitorQuestionDiv.textContent = question;

          const botReply = await getBotReply(question);
          botResponseDiv.textContent = botReply;
        } else {
          visitorQuestionDiv.textContent = "No visitor question found.";
          botResponseDiv.textContent = "N/A";
        }
      } catch (err) {
        console.error("SDK error:", err);
        visitorQuestionDiv.textContent = "Error loading visitor message.";
        botResponseDiv.textContent = "Error loading bot response.";
      }
    });
  </script>
</body>
</html>
